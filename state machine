{
  "Comment": "State machine to ensure ECS services are stable before initiating a new deployment",
  "StartAt": "Check Services Status",
  "States": {
    "Check Services Status": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:describeServices",
      "Parameters": {
        "Cluster.$": "$.ClusterName",
        "Services": [
          "$.ServiceName"
        ]
      },
      "ResultPath": "$.ServiceStatus",
      "Next": "Check If Services Are Stable"
    },
    "Check If Services Are Stable": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.ServiceStatus.services[0].deployments[0].status",
          "StringEquals": "PRIMARY",
          "Next": "Check If No Deployment In Progress"
        },
        {
          "Variable": "$.ServiceStatus.services[0].deployments[0].status",
          "IsPresent": true,
          "Next": "Wait"
        }
      ],
      "Default": "Wait"
    },
    "Check If No Deployment In Progress": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.ServiceStatus.services[0].deployments[0].rolloutState",
          "StringEquals": "COMPLETED",
          "Next": "Proceed With Deployment"
        }
      ],
      "Default": "Wait"
    },
    "Wait": {
      "Type": "Wait",
      "Seconds": 60,
      "Next": "Check Services Status"
    },
    "Proceed With Deployment": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:updateService",
      "Parameters": {
        "Cluster.$": "$.ClusterName",
        "Service.$": "$.ServiceName",
        "ForceNewDeployment": true
      },
      "Next": "Wait Before Monitoring"
    },
    "Wait Before Monitoring": {
      "Type": "Wait",
      "Seconds": 300,
      "Next": "Monitor Service"
    },
    "Monitor Service": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:describeServices",
      "Parameters": {
        "Cluster.$": "$.ClusterName",
        "Services": [
          "$.ServiceName"
        ]
      },
      "End": true
    }
  }
}
