{
  "Comment": "State machine to manage ECS service restarts ensuring only one service is restarted at a time",
  "StartAt": "Check or Initialize Flag",
  "States": {
    "Check or Initialize Flag": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.ExecutionInProgress",
          "IsPresent": true,
          "Next": "Check Running Execution"
        }
      ],
      "Default": "Initialize Flag"
    },
    "Initialize Flag": {
      "Type": "Pass",
      "Result": false,
      "ResultPath": "$.ExecutionInProgress",
      "Next": "Check Running Execution"
    },
    "Check Running Execution": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.ExecutionInProgress",
          "BooleanEquals": true,
          "Next": "Wait and Retry"
        }
      ],
      "Default": "Set In-Process Flag"
    },
    "Set In-Process Flag": {
      "Type": "Pass",
      "Result": true,
      "ResultPath": "$.ExecutionInProgress",
      "Next": "Update Service"
    },
    "Update Service": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:updateService",
      "Parameters": {
        "Cluster": "$.ClusterName",
        "Service": "$.ServiceName",
        "ForceNewDeployment": true
      },
      "Next": "Wait Before Monitoring"
    },
    "Wait Before Monitoring": {
      "Type": "Wait",
      "Seconds": 300,  // 5 minutes wait
      "Next": "Monitor Service"
    },
    "Monitor Service": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:describeServices",
      "Parameters": {
        "Cluster": "$.ClusterName",
        "Services": [
          "$.ServiceName"
        ]
      },
      "Next": "Clear In-Process Flag"
    },
    "Clear In-Process Flag": {
      "Type": "Pass",
      "Result": false,
      "ResultPath": "$.ExecutionInProgress",
      "Next": "End State Machine"
    },
    "End State Machine": {
      "Type": "Succeed"
    },
    "Wait and Retry": {
      "Type": "Wait",
      "Seconds": 30,
      "Next": "Check Running Execution"
    }
  }
}
