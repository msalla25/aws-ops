{
  "Comment": "State machine to ensure ECS services are not restarted simultaneously",
  "StartAt": "Describe All Services",
  "States": {
    "Describe All Services": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:describeServices",
      "Parameters": {
        "Cluster.$": "$.ClusterName",
        "Services": [
          "*"
        ]
      },
      "ResultPath": "$.AllServicesStatus",
      "Next": "Check Deployment Status"
    },
    "Check Deployment Status": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.AllServicesStatus.services[?(@.deployments[0].status == 'PRIMARY')].length",
          "NumericEquals": 0,
          "Next": "Proceed With Deployment"
        }
      ],
      "Default": "Wait"
    },
    "Wait": {
      "Type": "Wait",
      "Seconds": 60,
      "Next": "Describe All Services"
    },
    "Proceed With Deployment": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:updateService",
      "Parameters": {
        "Cluster.$": "$.ClusterName",
        "Service.$": "$.ServiceName",
        "ForceNewDeployment": true
      },
      "Next": "Wait Before Monitoring"
    },
    "Wait Before Monitoring": {
      "Type": "Wait",
      "Seconds": 300,
      "Next": "Monitor Service"
    },
    "Monitor Service": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:describeServices",
      "Parameters": {
        "Cluster.$": "$.ClusterName",
        "Services": [
          "$.ServiceName"
        ]
      },
      "End": true
    }
  }
}
