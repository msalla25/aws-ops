{
  "Comment": "Express Workflow to manage ECS service restarts ensuring no deployments are in progress",
  "StartAt": "Check Deployments",
  "States": {
    "Check Deployments": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:listTasks",
      "Parameters": {
        "Cluster.$": "$.ClusterName",
        "DesiredStatus": "RUNNING"
      },
      "ResultPath": "$.RunningTasks",
      "Next": "Evaluate Deployment Status"
    },
    "Evaluate Deployment Status": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.RunningTasks.tasks",
          "IsPresent": true,
          "Next": "Wait and Retry"
        }
      ],
      "Default": "Process Update"
    },
    "Wait and Retry": {
      "Type": "Wait",
      "Seconds": 30,
      "Next": "Check Deployments"
    },
    "Process Update": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:updateService",
      "Parameters": {
        "Cluster.$": "$.ClusterName",
        "Service.$": "$.ServiceName",
        "ForceNewDeployment": true
      },
      "HeartbeatSeconds": 300,  // Timeout to help manage parallel executions
      "Next": "Wait Before Monitoring"
    },
    "Wait Before Monitoring": {
      "Type": "Wait",
      "Seconds": 300,  // 5 minutes wait
      "Next": "Monitor Service"
    },
    "Monitor Service": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:describeServices",
      "Parameters": {
        "Cluster.$": "$.ClusterName",
        "Services": [
          "$.ServiceName"
        ]
      },
      "Next": "Finish"
    },
    "Finish": {
      "Type": "Pass",
      "End": true
    }
  }
}
