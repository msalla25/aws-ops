{
  "Comment": "State machine to restart a specified ECS service after validating deployment status of services",
  "StartAt": "Describe Validation Services",
  "States": {
    "Describe Validation Services": {
      "Type": "Map",
      "ItemsPath": "$.ValidationServices",
      "Iterator": {
        "StartAt": "Check Service Deployment",
        "States": {
          "Check Service Deployment": {
            "Type": "Task",
            "Resource": "arn:aws:states:::aws-sdk:ecs:describeServices",
            "Parameters": {
              "Cluster.$": "$.ClusterName",
              "Services": [
                "$$.Map.Item.Value"
              ]
            },
            "ResultPath": "$.ServiceStatus",
            "Next": "Check Deployment Status"
          },
          "Check Deployment Status": {
            "Type": "Choice",
            "Choices": [
              {
                "Variable": "$.ServiceStatus.services[0].deployments[0].status",
                "StringEquals": "PRIMARY",
                "Next": "Deployment In Progress"
              }
            ],
            "Default": "Service Stable"
          },
          "Deployment In Progress": {
            "Type": "Wait",
            "Seconds": 60,
            "Next": "Check Service Deployment"
          },
          "Service Stable": {
            "Type": "Pass",
            "Result": "Service is stable",
            "End": true
          }
        }
      },
      "ResultPath": "$.ValidationResults",
      "Next": "Check All Services Validated"
    },
    "Check All Services Validated": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.ValidationResults",
          "IsPresent": true,
          "Next": "Restart Specified Service"
        }
      ],
      "Default": "Fail"
    },
    "Restart Specified Service": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:updateService",
      "Parameters": {
        "Cluster.$": "$.ClusterName",
        "Service.$": "$.ServiceToRestart",
        "ForceNewDeployment": true
      },
      "Next": "Wait Before Monitoring"
    },
    "Wait Before Monitoring": {
      "Type": "Wait",
      "Seconds": 300,
      "Next": "Monitor Service"
    },
    "Monitor Service": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:describeServices",
      "Parameters": {
        "Cluster.$": "$.ClusterName",
        "Services": [
          "$.ServiceToRestart"
        ]
      },
      "End": true
    },
    "Fail": {
      "Type": "Fail",
      "Error": "DeploymentInProgress",
      "Cause": "One or more services have an ongoing deployment."
    }
  }
}
