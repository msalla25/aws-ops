{
  "Comment": "State machine to ensure ECS services are not restarted simultaneously",
  "StartAt": "Describe All Services",
  "States": {
    "Describe All Services": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:describeServices",
      "Parameters": {
        "Cluster.$": "$.ClusterName",
        "Services": ["*"]
      },
      "ResultPath": "$.AllServicesStatus",
      "Next": "Check Deployment Status"
    },
    "Check Deployment Status": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.AllServicesStatus.services",
          "IsPresent": true,
          "Next": "Check If Any Service Is In Progress"
        }
      ],
      "Default": "No Services Found"
    },
    "Check If Any Service Is In Progress": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.AllServicesStatus.services[0].deployments[0].status",
          "StringEquals": "PRIMARY",
          "Next": "Deployment In Progress"
        }
      ],
      "Default": "Proceed With Deployment"
    },
    "Deployment In Progress": {
      "Type": "Wait",
      "Seconds": 60,
      "Next": "Describe All Services"
    },
    "Proceed With Deployment": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:updateService",
      "Parameters": {
        "Cluster.$": "$.ClusterName",
        "Service.$": "$.ServiceName",
        "ForceNewDeployment": true
      },
      "Next": "Wait Before Monitoring"
    },
    "Wait Before Monitoring": {
      "Type": "Wait",
      "Seconds": 300,
      "Next": "Monitor Service"
    },
    "Monitor Service": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:describeServices",
      "Parameters": {
        "Cluster.$": "$.ClusterName",
        "Services": [
          "$.ServiceName"
        ]
      },
      "End": true
    },
    "No Services Found": {
      "Type": "Fail",
      "Error": "NoServicesError",
      "Cause": "No services found in the cluster."
    }
  }
}
