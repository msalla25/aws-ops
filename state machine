{
  "Comment": "State machine to manage ECS service restarts ensuring only one service is restarted at a time",
  "StartAt": "Initialize",
  "States": {
    "Initialize": {
      "Type": "Pass",
      "Result": {
        "ExecutionInProgress": false
      },
      "ResultPath": "$.ExecutionStatus",
      "Next": "Check Running Execution"
    },
    "Check Running Execution": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.ExecutionStatus.ExecutionInProgress",
          "BooleanEquals": true,
          "Next": "Wait and Retry"
        }
      ],
      "Default": "Set In-Process Flag"
    },
    "Set In-Process Flag": {
      "Type": "Pass",
      "Result": {
        "ExecutionInProgress": true
      },
      "ResultPath": "$.ExecutionStatus",
      "Next": "Update Service"
    },
    "Update Service": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:updateService",
      "Parameters": {
        "Cluster": "$.ClusterName",
        "Service": "$.ServiceName",
        "ForceNewDeployment": true
      },
      "Next": "Wait Before Monitoring"
    },
    "Wait Before Monitoring": {
      "Type": "Wait",
      "Seconds": 300,  // 5 minutes wait
      "Next": "Monitor Service"
    },
    "Monitor Service": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:ecs:describeServices",
      "Parameters": {
        "Cluster": "$.ClusterName",
        "Services": [
          "$.ServiceName"
        ]
      },
      "Next": "Clear In-Process Flag"
    },
    "Clear In-Process Flag": {
      "Type": "Pass",
      "Result": {
        "ExecutionInProgress": false
      },
      "ResultPath": "$.ExecutionStatus",
      "End": true
    },
    "Wait and Retry": {
      "Type": "Wait",
      "Seconds": 30,
      "Next": "Check Running Execution"
    }
  }
}
